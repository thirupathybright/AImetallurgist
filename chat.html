<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Metallurgist</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a1a;
            color: #ffffff;
        }

        .top-bar {
            background-color: #2d2d2d;
            border-bottom: 1px solid #333;
        }

        .chat-container {
            background-color: #1a1a1a;
        }

        .input-container {
            background-color: #2d2d2d;
            border: 1px solid #333;
        }

        .input-container:focus-within {
            border-color: #666;
        }

        .chat-bubble {
            position: relative;
            padding: 1rem;
            border-radius: 1rem;
            max-width: 80%;
            animation: bubbleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .user-bubble {
            background-color: #8B4000;
            color: white;
            margin-left: auto;
            margin-right: 1rem;
        }

        .assistant-bubble {
            background-color: #2d2d2d;
            margin-left: 1rem;
            color: #e5e7eb;
        }

        .feature-button {
            background-color: #2d2d2d;
            border: 1px solid #333;
            transition: all 0.2s;
        }

        .feature-button:hover {
            background-color: #333;
            border-color: #444;
        }

        .send-button {
            background-color: #8B4000;
            transition: all 0.2s;
        }

        .send-button:hover {
            background-color: #A0522D;
        }

        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .typing-dot {
            width: 4px;
            height: 4px;
            background: #666;
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        @keyframes bubbleIn {
            0% { 
                opacity: 0;
                transform: scale(0.8) translateY(20px);
            }
            100% { 
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 2px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #888;
        }

        /* Adding responsive design */
        @media (max-width: 640px) {
            .chat-container {
                padding: 0 1rem !important;
            }

            .chat-bubble {
                max-width: 90%;
            }

            .top-bar span {
                display: none;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    
    <!-- Top Navigation Bar -->
    <div class="top-bar p-2 flex items-center space-x-4">
        <div class="flex items-center space-x-2">
            <button class="p-2 feature-button rounded">
                <i class="fas fa-bars"></i>
            </button>
            <div class="flex items-center space-x-2">
                <img src="./images/ai.jpg" alt="User" class="w-8 h-8 rounded-full bg-gray-700"/>
                <span class="text-sm">Chat Interface</span>
            </div>
        </div>
        <div class="flex-grow"></div>
        <div class="flex items-center space-x-2">
            <button class="p-2 feature-button rounded" id="theme-toggle">
                <i class="fas fa-moon"></i>
            </button>
            <button class="p-2 feature-button rounded" id="fullscreen-toggle">
                <i class="fas fa-expand"></i>
            </button>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-grow flex flex-col h-[calc(100vh-120px)]">
        <!-- Chat Messages -->
        <div class="flex-grow overflow-y-auto custom-scrollbar p-4" id="chat-container" style="padding: 0 10vw;">
            <div class="flex justify-center mb-8">
                <div class="text-center">
                    <img src="images/Floating Robot-Photoroom.png" alt="Chat Logo" class="w-20 h-20 mx-auto mb-4"/>
                    <h1 class="text-2xl font-bold mb-2">AI METALLURGIST</h1>
                    <p class="text-gray-400">AI THIRUPATHYBRIGHT.COM</p>
                </div>
            </div>
        </div>
        <!-- Input Area -->
        <form id="chat-form" class="p-4">
            <div class="relative">
                <div class="input-container rounded-lg flex items-center p-2">
                    <input type="text" 
                           id="message-input"
                           class="flex-grow bg-transparent outline-none px-3 py-2"
                           placeholder="Ask Chat"
                           autocomplete="off">
                    
                    <div class="flex items-center space-x-2 px-2">
                        <button type="button" class="feature-button p-2 rounded text-gray-400 hover:text-white">
                            <i class="fas fa-palette"></i>
                        </button>
                        <button type="button" class="feature-button p-2 rounded text-gray-400 hover:text-white">
                            <i class="fas fa-globe"></i>
                        </button>
                        <button type="button" class="feature-button p-2 rounded text-gray-400 hover:text-white">
                            <i class="fas fa-image"></i>
                        </button>
                        <button type="button" 
                                id="clear-button"
                                class="feature-button p-2 rounded text-gray-400 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                        <button type="submit" 
                                class="send-button p-2 px-4 rounded text-white ml-2">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-gray-800 p-6 rounded-lg w-96">
            <h2 id="modal-title" class="text-xl text-white mb-4">Authentication Required</h2>
            
            <!-- Email/Phone Form -->
            <div id="auth-form">
                <input type="email" id="auth-email" placeholder="Email" class="w-full p-2 mb-4 bg-gray-700 text-white rounded">
                <input type="tel" id="auth-phone" placeholder="Phone" class="w-full p-2 mb-4 bg-gray-700 text-white rounded">
                <button id="send-otp-btn" class="w-full bg-blue-600 text-white p-2 rounded">Send OTP</button>
            </div>
            
            <!-- OTP Form -->
            <div id="otp-form" class="hidden">
                <input type="text" id="auth-otp" placeholder="Enter OTP" class="w-full p-2 mb-4 bg-gray-700 text-white rounded">
                <button id="verify-otp-btn" class="w-full bg-blue-600 text-white p-2 rounded">Verify OTP</button>
            </div>
        </div>
    </div>

   <script>
    // Constants
const API_URL = 'http://localhost:8000/chatbot/api/steel-inquiry/';
const AUTH_URL = 'http://localhost:8000/chatbot/api/auth/verify/';
const OTP_URL = 'http://localhost:8000/chatbot/api/auth/verify-otp/';

// Initialize chat
document.addEventListener('DOMContentLoaded', () => {
    loadChatHistory();
    initializeChat();
    document.getElementById('message-input').focus();
});

function initializeChat() {
    const messages = getChatHistory();
    if (messages.length === 0) {
        addMessage('assistant', "Welcome! I'm AI METALLURGIST. How can I help you today?");
    }
}

function getChatHistory() {
    return JSON.parse(localStorage.getItem('chatHistory') || '[]');
}

function addMessage(role, content, save = true) {
    const chatContainer = document.getElementById('chat-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `${role}-bubble chat-bubble mb-4`;
    messageDiv.innerHTML = `<p>${escapeHtml(content)}</p>`;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    if (save) {
        const messages = getChatHistory();
        messages.push({ role, content, timestamp: new Date().toISOString() });
        localStorage.setItem('chatHistory', JSON.stringify(messages));
        localStorage.setItem('messageCount', messages.length.toString());
    }
}

function loadChatHistory() {
    const chatContainer = document.getElementById('chat-container');
    chatContainer.innerHTML = `
        <div class="flex justify-center mb-8">
            <div class="text-center">
             <img src="images/Floating Robot-Photoroom.png" alt="Chat Logo" class="w-20 h-20 mx-auto mb-4"/>
                <h1 class="text-2xl font-bold mb-2">AI METALLURGIST</h1>
                <p class="text-gray-400">AI THIRUPATHYBRIGHT.COM</p>
            </div>
        </div>
    `;
    const messages = getChatHistory();
    messages.forEach(msg => {
        addMessage(msg.role, msg.content, false);
    });
}

// Form submission
// Form submission
// Form submission
document.getElementById('chat-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Check if the URL has a query parameter and remove it
    if (window.location.search) {
        const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
        window.history.pushState({ path: newUrl }, '', newUrl);
    }
    
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    if (!message) return;

    const messageCount = parseInt(localStorage.getItem('messageCount') || '0');
    const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';

    if (!isAuthenticated && messageCount >= 2) {
        document.getElementById('auth-modal').classList.remove('hidden');
        localStorage.setItem('pendingMessage', message);
        return;
    }

    input.value = '';
    await sendMessage(message);
});

async function sendMessage(message) {
    addMessage('user', message);

    // Show typing indicator
    const chatContainer = document.getElementById('chat-container');
    const typingIndicator = document.createElement('div');
    typingIndicator.id = 'typing-indicator';
    typingIndicator.className = 'assistant-bubble chat-bubble mb-4';
    typingIndicator.innerHTML = `
        <div class="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    `;
    chatContainer.appendChild(typingIndicator);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message })
        });

        const data = await response.json();
        typingIndicator.remove();
        
        if (data.status === 'success') {
            addMessage('assistant', data.response);
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        typingIndicator.remove();
        addMessage('assistant', 'Sorry, something went wrong. Please try again later.');
    }
}

// Clear button functionality
document.getElementById('clear-button').addEventListener('click', () => {
    document.getElementById('message-input').value = '';
    document.getElementById('message-input').focus();
});

// Fullscreen toggle
document.getElementById('fullscreen-toggle').addEventListener('click', () => {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
});

// Authentication handlers
document.getElementById('send-otp-btn').addEventListener('click', async () => {
    const email = document.getElementById('auth-email').value;
    const phone = document.getElementById('auth-phone').value;
    
    try {
        const response = await fetch(AUTH_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, phone })
        });

        if (response.ok) {
            document.getElementById('auth-form').classList.add('hidden');
            document.getElementById('otp-form').classList.remove('hidden');
            document.getElementById('modal-title').textContent = 'Enter OTP';
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Failed to send OTP');
    }
});

document.getElementById('verify-otp-btn').addEventListener('click', async () => {
    const email = document.getElementById('auth-email').value;
    const otp = document.getElementById('auth-otp').value;
    const phone = document.getElementById('auth-phone').value;
    
    try {
        const response = await fetch(OTP_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, otp, phone })
        });

        if (response.ok) {
            localStorage.setItem('isAuthenticated', 'true');
            document.getElementById('auth-modal').classList.add('hidden');
            
            const pendingMessage = localStorage.getItem('pendingMessage');
            if (pendingMessage) {
                localStorage.removeItem('pendingMessage');
                sendMessage(pendingMessage);
            }
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Invalid OTP');
    }
});

// URL parameter handling
window.addEventListener('DOMContentLoaded', () => {
    // Get the query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const searchQuery = urlParams.get('q');
    
    if (searchQuery) {
        // Decode the search value
        const decodedQuery = decodeURIComponent(searchQuery);
        
        // Set the input value
        const messageInput = document.getElementById('message-input');
        if (messageInput) {
            messageInput.value = decodedQuery;
            
            // Automatically submit the form
            const form = document.getElementById('chat-form');
            if (form) {
                form.dispatchEvent(new Event('submit'));
            }
        }
    }
});

// Escape HTML to prevent XSS
function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}
   </script>